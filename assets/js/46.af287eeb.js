(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{371:function(s,a,n){"use strict";n.r(a);var t=n(4),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("2018年第一篇文章，没啥技术含量，权当笔记")]),s._v(" "),a("p",[s._v("我们一般都会用git或者svn来管理我们的代码")]),s._v(" "),a("p",[s._v("每次代码更新后还要手动的去把服务器上的代码也更新一遍")]),s._v(" "),a("p",[s._v("项目小了还好  项目大了着实浪费时间")]),s._v(" "),a("p",[s._v("要是服务器上的代码也能像git那样增量更新就好了")]),s._v(" "),a("p",[s._v("今天就说说如何通过webhook的形式来让服务器自动拉取我们push的代码")]),s._v(" "),a("h1",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),a("p",[s._v("现在的Git服务器一般都会有个webhook服务")]),s._v(" "),a("p",[s._v("什么意思呢？")]),s._v(" "),a("p",[s._v("就是我们在执行了push、merge等一系列的操作的时候")]),s._v(" "),a("p",[s._v("Git服务器会发送一个请求到我们指定的URL")]),s._v(" "),a("p",[s._v("并且会把此次动作的相关数据也发送过去")]),s._v(" "),a("h2",{attrs:{id:"例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例"}},[s._v("#")]),s._v(" 例")]),s._v(" "),a("p",[s._v("这里我们使用开源中国的码云演示")]),s._v(" "),a("p",[s._v("在帮助文档中可以看到")]),s._v(" "),a("p",[s._v("当我们发生push之类的操作的时候")]),s._v(" "),a("p",[s._v("Git服务器会像我们指定的url发送以下数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{\n    "before": "fb32ef5812dc132ece716a05c50c7531c6dc1b4d", \n    "after": "ac63b9ba95191a1bf79d60bc262851a66c12cda1", \n    "ref": "refs/heads/master", \n    "user_id": 13,\n    "user_name": "123", \n    "user": {\n      "name": "123",\n      "username": "test123",\n      "url": "https://gitee.com/oschina"\n    }, \n    "repository": {\n        "name": "webhook", \n        "url": "http://git.oschina.net/oschina/webhook", \n        "description": "", \n        "homepage": "https://gitee.com/oschina/webhook"\n    }, \n    "commits": [\n        {\n            "id": "ac63b9ba95191a1bf79d60bc262851a66c12cda1", \n            "message": "1234 bug fix", \n            "timestamp": "2016-12-09T17:28:02 08:00", \n            "url": "https://gitee.com/oschina/webhook/commit/ac63b9ba95191a1bf79d60bc262851a66c12cda1", \n            "author": {\n                "name": "123", \n                "email": "123@123.com", \n                "time": "2016-12-09T17:28:02 08:00"\n            }\n        }\n    ], \n    "total_commits_count": 1, \n    "commits_more_than_ten": false, \n    "project": {\n        "name": "webhook", \n        "path": "webhook", \n        "url": "https://gitee.com/oschina/webhook", \n        "git_ssh_url": "git@gitee.com:oschina/webhook.git", \n        "git_http_url": "https://gitee.com/oschina/webhook.git", \n        "git_svn_url": "svn://gitee.com/oschina/webhook", \n        "namespace": "oschina", \n        "name_with_namespace": "oschina/webhook", \n        "path_with_namespace": "oschina/webhook", \n        "default_branch": "master"\n    }, \n    "hook_name": "push_hooks", \n    "password": "pwd"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("p",[s._v("于是乎，我们就可以拿这些数据来做做文章了")]),s._v(" "),a("h1",{attrs:{id:"准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备"}},[s._v("#")]),s._v(" 准备")]),s._v(" "),a("ul",[a("li",[s._v("一个git仓库")]),s._v(" "),a("li",[s._v("安装了web服务器与git支持的服务器")])]),s._v(" "),a("h1",{attrs:{id:"步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤"}},[s._v("#")]),s._v(" 步骤")]),s._v(" "),a("h2",{attrs:{id:"服务器篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器篇"}},[s._v("#")]),s._v(" 服务器篇")]),s._v(" "),a("p",[s._v("1.首先我们需要为www用户创建一个ssh密钥")]),s._v(" "),a("p",[s._v("切换到www用户下并生成一个rsa密钥")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("su - www\nssh-keygen -t rsa\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("密钥一般生成在 ==/var/www/.ssh/== 这个路径下")]),s._v(" "),a("p",[s._v("文件名为 id_rsa")]),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建一个可供Git服务器通知的页面")])]),s._v(" "),a("p",[s._v("网站的建立这里不再敷述")]),s._v(" "),a("p",[s._v("文件内容如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<?php\n//git webhook 自动部署脚本\n//项目存放物理路径\n$path = \"你的项目部署路径\";\n$requestBody = file_get_contents(\"php://input\");\nif (empty($requestBody)) {\n    die('send fail');\n}\n$content = json_decode($requestBody, true);\n//若是主分支且提交数大于0\nif ($content['ref']=='refs/heads/master' && $content['total_commits_count']>0) {\n    $res = shell_exec(\"cd {$path} && git pull 2>&1\");//以www用户运行\n    $res_log = '-------------------------'.PHP_EOL;\n    $res_log .= $content['user_name'] . ' 在' . date('Y-m-d H:i:s') . '向' . $content['repository']['name'] . '项目的' . $content['ref'] . '分支push了' . $content['total_commits_count'] . '个commit：' . PHP_EOL;\n    $res_log .= $res.PHP_EOL;\n    file_put_contents(\"git-webhook.txt\", $res_log, FILE_APPEND);//追加写入\n}\necho '很棒:'.date('y-m-d H:i:s');\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("以上代码相信都可以看懂")]),s._v(" "),a("p",[s._v("Git发送过来的数据相当丰富")]),s._v(" "),a("p",[s._v("我们可以用这些数据来做些过滤来决定是否需要更新服务器上的本地代码")]),s._v(" "),a("h2",{attrs:{id:"代码库篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代码库篇"}},[s._v("#")]),s._v(" 代码库篇")]),s._v(" "),a("ol",[a("li",[s._v("创建代码仓库")])]),s._v(" "),a("p",[s._v("创建方法这里不在敷述\n2. 添加ssh密钥")]),s._v(" "),a("p",[s._v("在项目管理中把上面步骤第一步中得到的ssh密钥添加到仓库的部署密钥中")]),s._v(" "),a("p",[s._v("这样我们的web服务器就有了拉取代码的权限\n3.添加hook路径")]),s._v(" "),a("p",[s._v("同样在项目管理中添加webhook链接")]),s._v(" "),a("p",[s._v("这里可以添加一个密码，我偷懒这里没加")]),s._v(" "),a("p",[s._v("需要加的话可以在hook文件中添加一个验证")]),s._v(" "),a("p",[s._v("可以防止被恶意访问")]),s._v(" "),a("h2",{attrs:{id:"联合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#联合"}},[s._v("#")]),s._v(" 联合")]),s._v(" "),a("p",[s._v("最后我们需要在我们的部署目录先把git初始化一次")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("su - www\ngit clone git仓库地址 项目部署地址\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("然后我们往git仓库中提交一次代码更新")]),s._v(" "),a("p",[s._v("稍等一下")]),s._v(" "),a("p",[s._v("如果一切正常的话我们的项目目录就会自动拉取你刚才提交的代码了")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("在hook路径中也有log记录")]),s._v(" "),a("p",[s._v("不需要的话可以把代码注释掉")])])}),[],!1,null,null,null);a.default=e.exports}}]);